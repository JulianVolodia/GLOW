<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>GLOW - Hello Cube - Please Check Source</title>
		<meta charset="utf-8">
		<style type="text/css">
			body {
				background:#ffffff;
				color:#000;
				padding:0;
				margin:0;
				overflow:hidden;
			}

			#glow { position: absolute; top: 10px; left: 10px; z-index:1000; }
			#glow span.title {margin:0 0 0 2px;border-bottom:8px solid #000;font:bold 12pt/16pt Arial, Helvetica;letter-spacing:1px;line-height:1.50}
			#glow span.title a {text-decoration:none;color:#000}
			#glow span.title a:visited {text-decoration:none;color:#000;}
			#glow span.sub {margin:0 0 0 3px;font:bold 6pt/6pt Arial, Helvetica, Sans-serif;text-transform:uppercase;}

		</style>
	</head>
	<body>
		<div id="glow"><span class="title"><a href="http://i-am-glow.com/">GLOW</a></span><br/><span class="sub">Hello Cube</span></div>
		<div id="container"></div>
		<script type="text/javascript" src="src/GLOW.js"></script>
		<script type="text/javascript" src="src/core/Context.js"></script>
		<script type="text/javascript" src="src/core/Compiler.js"></script>
		<script type="text/javascript" src="src/core/CompiledData.js"></script>
		<script type="text/javascript" src="src/core/FBO.js"></script>
		<script type="text/javascript" src="src/core/Texture.js"></script>
		<script type="text/javascript" src="src/core/Cache.js"></script>
		<script type="text/javascript" src="src/core/Shader.js"></script>
		<script type="text/javascript" src="src/core/Elements.js"></script>
		<script type="text/javascript" src="src/core/Uniform.js"></script>
		<script type="text/javascript" src="src/core/Attribute.js"></script>
		<script type="text/javascript" src="src/core/InterleavedAttributes.js"></script>

		<script type="text/javascript" src="src/extras/math/Float.js"></script>
		<script type="text/javascript" src="src/extras/math/Int.js"></script>
		<script type="text/javascript" src="src/extras/math/Vector2.js"></script>
		<script type="text/javascript" src="src/extras/math/Vector3.js"></script>
		<script type="text/javascript" src="src/extras/math/Matrix3.js"></script>
		<script type="text/javascript" src="src/extras/math/Matrix4.js"></script>

		<script type="text/javascript" src="src/extras/graph/Node.js"></script>
		<script type="text/javascript" src="src/extras/graph/Camera.js"></script>

		<script type="text/javascript" src="src/extras/geometry/Geometry.js"></script>
		<script type="text/javascript" src="src/extras/geometry/Cube.js"></script>
		<script type="text/javascript" src="src/extras/geometry/Plane.js"></script>
		<script type="text/javascript">
		
			// To get GLOW going, you need to create a GLOW.Context
			// We also set the background color to white
		
			var context = new GLOW.Context();
			context.setupClear( { red: 1, green: 1, blue: 1 } );


			// Attach the context's DOM element
		
			var container = document.getElementById( "container" );
			container.appendChild( context.domElement );


			// for sake of simplicity, create an object that
			// keep all information about our cube.
			
			// GLOW.Shader takes an object with the following properties:
			// vertexShader: the vertex shader code
			// fragmentShader: the fragment shader code
			// data: the uniform, attribute and texture data
			// elements: the element data 
		
			var canvas = document.createElement( "canvas" );
			canvas.width = "256";
			canvas.height= "256";
		
		//	document.body.appendChild(canvas);

			var context2d = canvas.getContext('2d');

			context2d.fillStyle = '#FF00FF';  
			context2d.fillRect(0, 0, 128, 128);
			context2d.fillStyle = '#000000';  
			context2d.fillRect(128, 128, 128, 128);


			var cubeShaderInfo = {
				
				// create vertex shader (note: cameraInverse * transform is usually done in JS)

				vertexShader: [

					"uniform	mat4 	transform;",
					"uniform	mat4 	rotation;",
					"uniform 	mat4 	cameraInverse;",
					"uniform 	mat4 	cameraProjection;",

					"attribute 	vec3 	vertices;",
					"attribute  vec3	normals;",
					"attribute  vec2    uvs;",
					
					"varying    vec2    uv;",
					"varying    float   light;",

					"void main(void)",
					"{",
						"uv = uvs;",
						"light = dot( normalize( mat3( rotation[0].xyz, rotation[1].xyz, rotation[2].xyz ) * normals ), vec3( 0.0, 0.0, -1.0 ));",
						"gl_Position = cameraProjection * cameraInverse * transform * rotation * vec4( vertices, 1.0 );",
					"}"
						
				].join( "\n" ),


				// create fragment shader

				fragmentShader: [ 	

					"#ifdef GL_ES",
						"precision highp float;",
					"#endif",		

					"uniform 	sampler2D 	texture;",
					"varying    float  	 	light;",
					"varying 	vec2		uv;",

					"void main( void )",
					"{",
						"gl_FragColor = texture2D( texture, uv ) * light;",
					"}"

				].join( "\n" ),


				// create all uniform and attribute data

				data: {
					
					// create uniform data

					transform: new GLOW.Matrix4(),
					rotation: new GLOW.Matrix4(),
					cameraInverse: GLOW.defaultCamera.inverse,
					cameraProjection: GLOW.defaultCamera.projection,
					texture: new GLOW.Texture( { canvas:canvas } ),


					// create attribute data

					vertices: GLOW.Geometry.Cube.vertices( 50 ),
					uvs: GLOW.Geometry.Cube.uvs(),
					normals: GLOW.Geometry.faceNormals( GLOW.Geometry.Cube.vertices(), GLOW.Geometry.Cube.elements())
				},
				

				// create element data
				
				elements: GLOW.Geometry.Cube.elements(),
			}
			

			// Then we compile the data to be used for shader creation later
			
			var compiledCubeShaderInfo = GLOW.Compiler.compile( cubeShaderInfo );
			
			// create clones
			// note that we use the compiled data except the transform, which is unique for each clone.
			// note that except: is an object and can contain multiple unique data objects
			
			var cube, cubes = [];
			
			for( var i = 0; i < 1000; i++ ) {
				
				cube = new GLOW.Shader( { use: compiledCubeShaderInfo, except: { transform: new GLOW.Matrix4() } } );
				cube.transform.setPosition( Math.sin( i * 0.5 ) * i, Math.cos( i * 0.5 ) * i, 1000 - i * 2 );
				
				cubes.push( cube );
			}
			
			
			// Update the default camera position
			
			GLOW.defaultCamera.localMatrix.setPosition( 0, 0, 1500 );
			GLOW.defaultCamera.update();
			
			
			// Render (using setInterval as WebGL Inspector have problem with requestAnimationFrame)
 
			setInterval( render, 1000 / 60 );

			function render() {

				// the rotation uniform is shared, update this to make all rotate
				
				cubes[ 0 ].rotation.addRotation( 0.01, 0.01, 0.01 );
				

				// clear the context's cache and graphics
				
				context.cache.clear();
				context.clear();

				// draw cubes
				
				for( var i = 0; i < cubes.length; i++ ) {
					
					cubes[ i ].draw();
				}
			}
		</script>
	</body>
</html>
