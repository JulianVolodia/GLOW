<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>GLOW</title>
		<meta charset="utf-8">
		<style type="text/css">
			body {
				background:#000;
				color:#fff;
				padding:0;
				margin:0;
				overflow:hidden;
				font-family:georgia;
				text-align:center;
			}
		</style>
	</head>
	<body>
		<div id="container"></div>

		<script type="text/javascript" src="src/GLOW.js"></script>
		<script type="text/javascript" src="src/core/Context.js"></script>
		<script type="text/javascript" src="src/core/FBO.js"></script>
		<script type="text/javascript" src="src/core/Float.js"></script>
		<script type="text/javascript" src="src/core/Int.js"></script>
		<script type="text/javascript" src="src/core/Vector3.js"></script>
		<script type="text/javascript" src="src/core/Matrix3.js"></script>
		<script type="text/javascript" src="src/core/Matrix4.js"></script>
		<script type="text/javascript" src="src/core/Texture.js"></script>
		<script type="text/javascript" src="src/core/Cache.js"></script>
		<script type="text/javascript" src="src/core/Camera.js"></script>
		
		<script type="text/javascript" src="src/shader/Shader.js"></script>
		<script type="text/javascript" src="src/shader/Uniform.js"></script>
		<script type="text/javascript" src="src/shader/Attribute.js"></script>

		<script type="text/javascript" src="src/extras/geometry/Geometry.js"></script>
		<script type="text/javascript" src="src/extras/geometry/Cube.js"></script>
		<script type="text/javascript" src="src/extras/geometry/Plane.js"></script>
		<script type="text/javascript" src="src/extras/graph/Node.js"></script>

		<script type="text/javascript" src="examples/js/Stats.js"></script>

		<script type="text/javascript">
		
			var shaderInfo = {
				
				setup: function() {
					
					this.clouds = GLOW.Texture( "examples/textures/clouds.jpg" );

					this.time = GLOW.Float();
					this.pulse = GLOW.Float();
					this.offset = GLOW.Float();
					this.transform = GLOW.Matrix4();
					this.cameraInverse = GLOW.defaultCamera.inverse;
					this.cameraProjection = GLOW.defaultCamera.projection;

					this.vertices = GLOW.Geometry.Cube.vertices( 50 );
					this.elements = GLOW.Geometry.Cube.elements();
					this.uvs = GLOW.Geometry.Cube.uvs();
					this.normals = GLOW.Geometry.faceNormals( this.vertices, this.elements );
					
				},
	
				vertexShader: [

					"uniform	mat4 	transform;",
					"uniform 	mat4 	cameraInverse;",
					"uniform 	mat4 	cameraProjection;",
					"uniform    float   offset;",
					"uniform    float   time;",

					"attribute 	vec3 	vertices;",
					"attribute  vec3	normals;",
					
					"varying 	float	lightWeight;",

					"void main(void)",
					"{",
						"vec3 transformedNormal = mat3( transform[ 0 ].xyz, transform[ 1 ].xyz, transform[ 2 ].xyz ) * normals;",
						"lightWeight = dot( transformedNormal, vec3( 0.0, 1.0, 0.0 ));",
						"gl_Position = cameraProjection * cameraInverse * transform * vec4( vertices * ( sin( time * 5.0 + offset ) * 0.5 + 1.0 ), 1.0 );",
					"}"
						
				].join( "\n" ),

				fragmentShader: [ 	

					"#ifdef GL_ES",
						"precision highp float;",
					"#endif",		

					"uniform 	sampler2D 	clouds;",
					"uniform	float		glow;",
					"uniform	float		time;",
					"varying 	float		lightWeight;",

					"void main( void )",
					"{",
						"gl_FragColor = vec4( sin( glow + time ), cos( glow + time ), sin( glow + time * 2.0 ), 1.0 );",
					"}"

				].join( "\n" )
			}
			
			shaderInfo.setup();
			
			
			
			var postShaderInfo = {
				
				aspect: GLOW.Float( window.innerHeight / window.innerWidth ),
				cameraProjection: GLOW.defaultCamera.projection,
				texture: undefined,
				vertices: GLOW.Geometry.Plane.vertices(),
				uvs: GLOW.Geometry.Plane.uvs(),
				elements: GLOW.Geometry.Plane.elements(),
				
				vertexShader: [

					"uniform    float   aspect;",
					"uniform    mat4    cameraProjection;",

					"attribute 	vec3 	vertices;",
					"attribute  vec2	uvs;",
					
					"varying 	vec2	uv;",

					"void main(void)",
					"{",
						"uv = uvs;",
						"gl_Position = vec4( vertices.x, vertices.y, 1.0, 1.0 );",
					"}"
						
				].join( "\n" ),

				fragmentShader: [ 	

					"#ifdef GL_ES",
						"precision highp float;",
					"#endif",		

					"uniform 	sampler2D 	texture;",
					"varying 	vec2		uv;",

					"void main( void )",
					"{",
						"gl_FragColor = texture2D( texture, uv );// + vec4( 0.5, 0.0, 0.5, 0.0 );",
					"}"

				].join( "\n" )
			}
		
		</script>

		<script type="text/javascript">

			var container, stats;
			var mouseX = 0, mouseY = 0;
			var shaders, topNode, context, t = 0;
			var postShader;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			var FBO;
			
			
			// init cubes
			
			context = GLOW.Context();
			shaders = [];
			topNode = GLOW.Node();
			
			var thisNode;
			var prevNode = topNode;
			
			for( var a = 0; a < 10; a++ ) {
				
				thisNode = GLOW.Node();
				thisNode.localMatrix.setPosition( 50, 50, 0 );

				prevNode.addChild( thisNode );
				prevNode = thisNode;

				
				shaderInfo.transform = thisNode.globalMatrix;
				shaderInfo.glow      = GLOW.Float( Math.random());
				shaderInfo.offset    = GLOW.Float( a );

				shaders.push( GLOW.Shader( shaderInfo ));
			}
			
			topNode.update();
			
			
			// init post shader
			
			postShaderInfo.texture = FBO = GLOW.FBO();
			postShader = GLOW.Shader( postShaderInfo );
			
			
			
			// init dom and camera
			
			container = document.getElementById( 'container' );
			container.appendChild( context.domElement );
			
			GLOW.defaultCamera.setPosition( 0, 0, 1500 );
			GLOW.defaultCamera.update();
			
			
			// stats

			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			container.appendChild( stats.domElement );

				
			// render

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			setInterval( render, 1000 / 30 );

			function render() {

				var a, al = shaders.length;
				var shader;

				t += 0.01;

				//GLOW.defaultCamera.setPosition( Math.sin( t ) * 1000, -mouseY * 2000, Math.cos( t ) * 1000 ).update();
				GLOW.Cache.clear();
				
				FBO.bind();
				context.clear();

				shaders[ 0 ].time.value = t;
				
				for( a = 0; a < al; a++ ) {
					
					shaders[ a ].draw();
				}

				FBO.unbind();
				postShader.draw();

				stats.update();
			}


			//--- on mouse move ---
			
			function onDocumentMouseMove( event ) {

				mouseX = ( event.clientX - windowHalfX ) / windowHalfX * 2; 
				mouseY = ( event.clientY - windowHalfY ) / windowHalfY * 2;

			}
		</script>
	</body>
</html>
